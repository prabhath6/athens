{"version":3,"sources":["athens/devcards/athena.cljs"],"mappings":"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","names":["G__52609","re-frame.core/dispatch","js/athens","js/athens.devcards","js/athens.devcards.athena","js/athens.devcards.athena.conn","athens.devcards.athena/conn","athens.devcards.db/new-conn","athens.devcards.db/posh-conn!","athens.devcards.athena/handler","n","cljs.core/deref","n-child","datascript.core.transact_BANG_.cljs$core$IFn$_invoke$arity$2","athens.devcards.athena/athena-prompt","athens.lib.dom.attributes.with_attributes.cljs$core$IFn$_invoke$arity$variadic","athens.lib.dom.attributes.with_styles.cljs$core$IFn$_invoke$arity$1","G__52610","js/module$node_modules$$material_ui$icons$index.Search","athens.devcards.athena/re-case-insensitive","query","cljs.core/re-pattern","athens.devcards.athena/search-in-block-title","db","G__52611","G__52612","G__52613","datascript.core/q","athens.devcards.athena/get-parent-node","block","b","cljs.core.assoc.cljs$core$IFn$_invoke$arity$3","cljs.core/first","athens.devcards.athena/search-in-block-content","G__52615","G__52616","G__52617","cljs.core.map.cljs$core$IFn$_invoke$arity$2","p1__52614#","cljs.core.dissoc.cljs$core$IFn$_invoke$arity$2","athens.devcards.athena/highlight-match","txt","query-pattern","cljs.core.map_indexed.cljs$core$IFn$_invoke$arity$2","i","part","cljs.core/re-find","clojure.string.split.cljs$core$IFn$_invoke$arity$2","athens.devcards.athena/+query","athens.lib.dom.attributes.with_styles.cljs$core$IFn$_invoke$arity$variadic","athens.style/+depth-64","athens.devcards.athena/+athena-input","athens.devcards.athena/recent","athens.style/+flex-space-between","athens.devcards.athena/+container","athens.devcards.athena/athena","conn","*cache","reagent.core.atom.cljs$core$IFn$_invoke$arity$1","*match","datascript.core/db","athena?","G__52618","re-frame.core/subscribe","handler","e","clojure.string/blank?","cljs.core/reset!","result","or__4185__auto__","cljs.core.get.cljs$core$IFn$_invoke$arity$2","G__52619","cljs.core/count","cljs.core.swap_BANG_.cljs$core$IFn$_invoke$arity$4","cljs.core/assoc","vec__52620","cljs.core.nth.cljs$core$IFn$_invoke$arity$3","map__52623","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply.cljs$core$IFn$_invoke$arity$2","cljs.core/hash-map","pages","blocks","iter__4582__auto__","s__52626","cljs.core/LazySeq","temp__5735__auto__","cljs.core/seq","cljs.core/chunked-seq?","c__4580__auto__","size__4581__auto__","b__52628","cljs.core/chunk-buffer","i__52627","vec__52637","cljs.core._nth.cljs$core$IFn$_invoke$arity$2","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__52625","cljs.core/chunk-rest","vec__52654","cljs.core/cons","cljs.core/rest","x","cljs.core/list","cljs.core.take.cljs$core$IFn$_invoke$arity$2","cljs.core.concat.cljs$core$IFn$_invoke$arity$2","parent","page-title","block-uid","block-string","athens.router/navigate-page","js/module$node_modules$$material_ui$icons$index.ChevronRight","cljs.core/chunk-first"],"sourcesContent":["(ns athens.devcards.athena\n  (:require\n    [\"@material-ui/icons\" :as mui-icons]\n    [athens.devcards.db :refer [new-conn posh-conn! load-real-db-button]]\n    [athens.events]\n    [athens.lib.dom.attributes :refer [with-attributes with-styles]]\n    [athens.router :refer [navigate-page]]\n    [athens.style :refer [style-guide-css +flex-space-between +depth-64]]\n    [athens.subs]\n    [cljsjs.react]\n    [cljsjs.react.dom]\n    [datascript.core :as d]\n    [devcards.core :refer-macros [defcard-rg]]\n    [re-frame.core :refer [subscribe dispatch]]\n    [reagent.core :as r]))\n\n\n(defcard-rg Import-Styles\n  [style-guide-css])\n\n\n(defcard-rg Instantiate-app-db\n  \"Using re-frame, even though DevCards </3 re-frame. Not using re-frame elsewhere for subs, but will probably\n  need refactoring or real isolation later.\n\n  - https://github.com/athensresearch/athens/issues/126\n  - https://github.com/bhauman/devcards/issues/105\n  - https://github.com/bhauman/devcards/pull/131/\n  \")\n\n\n(dispatch [:init-rfdb])\n\n(defcard-rg Instantiate-Dsdb)\n(defonce conn (new-conn))\n(posh-conn! conn)\n\n\n(defn handler\n  []\n  (let [n (inc (:max-eid @conn))\n        n-child (inc n)]\n    (d/transact! conn [{:node/title     (str \"Test Page \" n)\n                        :block/uid      (str \"uid-\" n)\n                        :block/children [{:block/string (str \"Test Block\" n-child) :block/uid (str \"uid-\" n-child)}]}])))\n\n\n(defcard-rg Create-Page\n  \"Press button and then search \\\"test\\\" \"\n  [:button.primary {:on-click handler} \"Create Test Pages and Blocks\"])\n\n\n(defcard-rg Load-Real-DB\n  [load-real-db-button conn])\n\n\n(defn athena-prompt\n  []\n  [:button.primary (with-attributes (with-styles {:padding 0})\n                     {:on-click #(dispatch [:toggle-athena])})\n   [:div (with-styles {:display \"inline-block\" :padding \"6px 0 6px 8px\"})\n    [:> mui-icons/Search]]\n   [:div (with-styles {:display \"inline-block\" :font-weight \"normal\" :padding \"6px 16px\" :color \"#322F38\"})\n    \"Find or Create a Page\"]])\n\n\n(defn re-case-insensitive\n  \"More options here https://clojuredocs.org/clojure.core/re-pattern\"\n  [query]\n  (re-pattern (str \"(?i)\" query)))\n\n\n(defn search-in-block-title\n  [db query]\n  (d/q '[:find [(pull ?node [:db/id :node/title :block/uid]) ...]\n         :in $ ?query-pattern\n         :where\n         [?node :node/title ?txt]\n         [(re-find ?query-pattern ?txt)]]\n       db\n       (re-case-insensitive query)))\n\n\n(defn get-parent-node\n  [block]\n  (loop [b block]\n    (if (:node/title b)\n      (assoc block :block/parent b)\n      (recur (first (:block/_children b))))))\n\n\n(defn search-in-block-content\n  [db query]\n  (->>\n    (d/q '[:find [(pull ?block [:db/id :block/uid :block/string :node/title {:block/_children ...}]) ...]\n           :in $ ?query-pattern\n           :where\n           [?block :block/string ?txt]\n           [(re-find ?query-pattern ?txt)]]\n         db\n         (re-case-insensitive query))\n    (map get-parent-node)\n    (map #(dissoc % :block/_children))))\n\n\n(defn highlight-match\n  [query txt]\n  (let [query-pattern (re-case-insensitive (str \"((?<=\" query \")|(?=\" query \"))\"))]\n    (map-indexed (fn [i part]\n                   (if (re-find query-pattern part)\n                     [:span {:key i :style {:background-color \"#F9A132\" :font-size \"inherit\" :line-height \"inherit\"}} part]\n                     part))\n                 (clojure.string/split txt query-pattern))))\n\n\n(def +query\n  (with-styles +depth-64\n    {:background-color \"white\"\n     :position \"absolute\"\n     :z-index  99\n     :top      \"100%\"\n     :left     0\n     :right    0\n     :overflow-y \"auto\"\n     :max-height \"500px\"}))\n\n\n(def +athena-input\n  (with-styles {:width \"100%\"\n                :border 0\n                :font-size      \"38px\"\n                :font-weight    \"300\"\n                :line-height    \"49px\"\n                :letter-spacing \"-0.03em\"\n                :color          \"#433F38\"\n                :padding \"25px 0 25px 35px\"\n                :cursor \"text\"}))\n\n\n(defn recent\n  []\n  [:div (with-styles +flex-space-between {:padding \"0px 18px 0px 32px\" :background-color \"white\" :border-top \"1px solid rgba(67, 63, 56, .5)\"})\n   [:h5 \"Recent\"]\n   [:div\n    [:span \"Press \"]\n    [:span (with-styles {:text-transform \"uppercase\" :font-family \"IBM Plex Sans Condensed\" :font-size \"12px\" :font-weight 600\n                         :border \"1px solid rgba(67, 63, 56, 0.25)\" :border-radius \"4px\"\n                         :padding \"0 4px\"})\n     \"shift + enter\"]\n    [:span \" to open in right sidebar.\"]]])\n\n\n(def +container\n  (with-styles +depth-64\n    {:width         \"784px\"\n     :border-radius \"4px\"\n     :display       \"inline-block\"\n     :position      \"fixed\"\n     :top           \"30%\"\n     :left          \"50%\"\n     :transform     \"translate(-50%, -50%)\"\n     :z-index       2}))\n\n\n(defn athena\n  [conn]\n  (let [*cache (r/atom {})\n        *match (r/atom nil)\n        db (d/db conn)\n        athena? (subscribe [:athena])\n        handler (fn [e]\n                  (let [query (.. e -target -value)]\n                    (if (clojure.string/blank? query)\n                      (reset! *match [query nil])\n                      (let [result (or (get @*cache query)\n                                       (cond-> {:pages (search-in-block-title db query)}\n                                         (count query) (assoc :blocks (search-in-block-content db query))))]\n                        (swap! *cache assoc query result)\n                        (reset! *match [query result])))))]\n    (when @athena?\n      [:div +container\n       [:div {:style {:box-shadow \"inset 0px -1px 0px rgba(0, 0, 0, 0.1)\"}}\n        [:input (with-attributes +athena-input\n                  {:type        \"search\"\n                   :placeholder \"Find or Create Page\",\n                   :on-change   handler})]]\n       [recent]\n       [(fn []\n          (let [[query {:keys [pages blocks] :as result}] @*match]\n            (when result\n              [:div (with-styles +query)\n               (for [[i x] (map-indexed list (take 40 (concat (take 20 pages) blocks)))]\n                 (let [parent (:block/parent x)\n                       page-title (or (:node/title parent) (:node/title x))\n                       block-uid (or (:block/uid parent) (:block/uid x))\n                       block-string (:block/string x)]\n                   [:div (with-attributes {:class \"athena-result\" :key i :on-click #(navigate-page block-uid)})\n                    [:div\n                     [:h4 (highlight-match query page-title)]\n                     (when block-string\n                       [:span (highlight-match query block-string)])]\n                    [:h4 (with-styles {:margin-left \"auto\"}) [:> mui-icons/ChevronRight]]]))])))]])))\n\n\n(defcard-rg Athena-Prompt\n  \"Must press again to close. Doesn't go away if you click outside.\"\n  [:<>\n   [athena-prompt]\n   [athena conn]])\n"]}