{"version":3,"sources":["athens/listeners.cljs"],"mappings":"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","names":["athens.listeners/mouse-down-bullet","e","class-list","cljs.core.array_seq.cljs$core$IFn$_invoke$arity$1","p1__61445#","cljs.core/some","cljs.core._EQ_.cljs$core$IFn$_invoke$arity$2","start-pos","uid","on-move","athens.listeners/mouse-move-bullet","goog.events/listen","js/window","goog.events.EventType/MOUSEMOVE","athens.listeners/mouse-up-bullet","_","map__61446","cljs.core/deref","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply.cljs$core$IFn$_invoke$arity$2","cljs.core/hash-map","cljs.core.get.cljs$core$IFn$_invoke$arity$2","kind","target-uid","G__61447","re-frame.core/subscribe","and__4174__auto__","G__61449","re-frame.core/dispatch","G__61450","goog.events/unlisten","cX","cY","x","y","closest-child","js/document.elementFromPoint","closest-sibling","closest-child-uid","closest-sibling-uid","closest-uid","or__4185__auto__","closest-kind","G__61451","athens.listeners/mouse-down-block","closest-block","closest-block-header","closest-page-header","closest","G__61452","athens.listeners/mouse-over-bullet","tooltip-uid","G__61454","p1__61453#","G__61455","G__61456","athens.listeners/mouse-down-outside-athena","athena?","G__61457","G__61458","athens.listeners/key-down","key","ctrl","meta","shift","goog.events.KeyCodes/Z","G__61459","G__61460","goog.events.KeyCodes/K","G__61461","goog.events.KeyCodes/G","G__61462","goog.events.KeyCodes/R","G__61463","goog.events.KeyCodes/L","G__61464","athens.listeners/init","goog.events.EventType/MOUSEDOWN","goog.events.EventType/MOUSEOVER","goog.events.EventType/KEYDOWN"],"sourcesContent":["(ns athens.listeners\r\n  (:require\r\n    [cljsjs.react]\r\n    [cljsjs.react.dom]\r\n    [goog.events :as events]\r\n    [re-frame.core :refer [dispatch subscribe]])\r\n  (:import\r\n    (goog.events\r\n      EventType\r\n      KeyCodes)))\r\n\r\n\r\n;;; Drag Bullet to Re-order Block\r\n\r\n\r\n(declare mouse-move-bullet mouse-up-bullet)\r\n\r\n\r\n(defn mouse-down-bullet\r\n  [e]\r\n  (let [class-list (-> (.. e -target -classList) array-seq)]\r\n    (when (some #(= \"bullet\" %) class-list)\r\n      (let [start-pos {:x (.-clientX e)\r\n                       :y (.-clientY e)}\r\n            uid (.. e -target -dataset -uid)\r\n            on-move (mouse-move-bullet start-pos uid)]\r\n        (events/listen js/window EventType.MOUSEMOVE on-move)\r\n        (set! (.. e -target -onmouseup) (mouse-up-bullet on-move))))))\r\n\r\n\r\n(defn mouse-up-bullet\r\n  [on-move]\r\n  (fn [_]\r\n    (let [{:keys [uid closest/kind] target-uid :closest/uid} @(subscribe [:drag-bullet])]\r\n      (when (and uid kind target-uid)\r\n        (dispatch [:drop-bullet uid target-uid kind]))\r\n      (dispatch [:drag-bullet nil])\r\n      ;; FIXME: after the first time `empty` is called, selection stays empty\r\n      ;;(.. (js/document.getSelection) empty)\r\n      (events/unlisten js/window EventType.MOUSEMOVE on-move))))\r\n\r\n\r\n(defn mouse-move-bullet\r\n  \"Must set hidden to true for bullet, otherwise bullet is captured when calling `elementFromPoint`.\r\n  Closest child always takes precedent over closest sibling, because .block-contents is nested within .block-container.\r\n  `cljs-oops` provides macros that let you bypass null `when` checks\"\r\n  [start-pos uid]\r\n  (fn [e]\r\n    (let [cX (.-clientX e)\r\n          cY (.-clientY e)\r\n          x (- cX (:x start-pos))\r\n          y (- cY (:y start-pos))]\r\n      (set! (.. e -target -hidden) true)\r\n      (let [closest-child   (.. (js/document.elementFromPoint cX cY) (closest \".block-contents\"))\r\n            closest-sibling (.. (js/document.elementFromPoint cX cY) (closest \".block-container\"))\r\n            closest-child-uid (when closest-child (.. closest-child -dataset -uid))\r\n            closest-sibling-uid (when closest-sibling (.. closest-sibling -dataset -uid))\r\n            ;; nilable\r\n            closest-uid (or closest-child-uid closest-sibling-uid)\r\n            ;; nilable\r\n            closest-kind (cond closest-child-uid   :child\r\n                               closest-sibling-uid :sibling)]\r\n        (set! (.. e -target -hidden) false)\r\n        (dispatch [:drag-bullet\r\n                   {:x            x\r\n                    :y            y\r\n                    :uid          uid\r\n                    :closest/uid  closest-uid\r\n                    :closest/kind closest-kind}])))))\r\n\r\n\r\n;;; Turn read block or header into editable on mouse down\r\n\r\n\r\n(defn mouse-down-block\r\n  [e]\r\n  ;; Consider refactor if we add more editable targets\r\n  (let [closest-block (.. e -target (closest \".block-contents\"))\r\n        closest-block-header (.. e -target (closest \".block-header\"))\r\n        closest-page-header (.. e -target (closest \".page-header\"))\r\n        closest (or closest-block closest-block-header closest-page-header)]\r\n    (when closest\r\n      (dispatch [:editing-uid (.. closest -dataset -uid)]))))\r\n\r\n\r\n;;; Show tooltip\r\n\r\n\r\n(defn mouse-over-bullet\r\n  [e]\r\n  (let [class-list (array-seq (.. e -target -classList))\r\n        closest (.. e -target (closest \".tooltip\"))\r\n        uid (.. e -target -dataset -uid)\r\n        tooltip-uid @(subscribe [:tooltip-uid])]\r\n    (cond\r\n      ;; if mouse over bullet, show tooltip\r\n      (some #(= \"bullet\" %) class-list) (dispatch [:tooltip-uid uid])\r\n      ;; if mouse over a child of bullet, keep tooltip-uid\r\n      closest nil\r\n      ;; if tooltip is already nil, don't overwrite tooltip-uid\r\n      (nil? tooltip-uid) nil\r\n      ;; otherwise mouse is no longer over a bullet or tooltip. clear the tooltip-uid\r\n      :else (dispatch [:tooltip-uid nil]))))\r\n\r\n\r\n;;; Close Athena\r\n\r\n\r\n(defn mouse-down-outside-athena\r\n  [e]\r\n  (let [athena? @(subscribe [:athena])\r\n        closest (.. e -target (closest \".athena\"))]\r\n    (when (and athena? (nil? closest))\r\n      (dispatch [:toggle-athena]))))\r\n\r\n\r\n;;; Hotkeys\r\n\r\n(defn key-down\r\n  [e]\r\n  (let [key (.. e -keyCode)\r\n        ctrl (.. e -ctrlKey)\r\n        meta (.. e -metaKey)\r\n        shift (.. e -shiftKey)]\r\n\r\n    (cond\r\n      (and (= key KeyCodes.Z) meta shift)\r\n      (dispatch [:redo])\r\n\r\n      (and (= key KeyCodes.Z) meta)\r\n      (dispatch [:undo])\r\n\r\n      (and (= key KeyCodes.K) meta)\r\n      (dispatch [:toggle-athena])\r\n\r\n      (and (= key KeyCodes.G) ctrl)\r\n      (dispatch [:toggle-devtool])\r\n\r\n      (and (= key KeyCodes.R) ctrl)\r\n      (dispatch [:right-sidebar/toggle])\r\n\r\n      (and (= key KeyCodes.L) ctrl)\r\n      (dispatch [:toggle-left-sidebar]))))\r\n\r\n\r\n(defn init\r\n  []\r\n  (events/listen js/window EventType.MOUSEDOWN mouse-down-block)\r\n  (events/listen js/window EventType.MOUSEDOWN mouse-down-bullet)\r\n  (events/listen js/window EventType.MOUSEOVER mouse-over-bullet)\r\n  (events/listen js/window EventType.MOUSEDOWN mouse-down-outside-athena)\r\n  (events/listen js/window EventType.KEYDOWN key-down))\r\n"]}